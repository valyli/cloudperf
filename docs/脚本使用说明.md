# CloudPerf è„šæœ¬ä½¿ç”¨è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ `script/` ç›®å½•ä¸‹å„ä¸ªè„šæœ¬çš„åŠŸèƒ½å’Œä½¿ç”¨æ–¹æ³•ã€‚

## æ ¸å¿ƒç®¡ç†è„šæœ¬

### admin_exec.sh - ç³»ç»Ÿç®¡ç†å·¥å…·
**åŠŸèƒ½**: è°ƒç”¨ç®¡ç†Lambdaå‡½æ•°æ‰§è¡Œå„ç§ç³»ç»Ÿç®¡ç†ä»»åŠ¡

**ç”¨æ³•**:
```bash
./script/admin_exec.sh [action] [param]
```

**å¸¸ç”¨å‘½ä»¤**:
```bash
# åˆ›å»ºç”¨æˆ·
./script/admin_exec.sh create_user admin

# æ‰§è¡ŒSQLæŸ¥è¯¢
./script/admin_exec.sh exec_sql "select * from country limit 10"

# å¯¼å‡ºæ•°æ®åº“è¡¨
./script/admin_exec.sh mysql_dump "country,city,asn,iprange,cityset"

# åˆå§‹åŒ–æ•°æ®åº“
./script/admin_exec.sh exec_sql init_db
```

**æ³¨æ„äº‹é¡¹**:
- ä¾èµ–ç¯å¢ƒå˜é‡ `CDK_DEFAULT_REGION`ï¼Œé»˜è®¤ä¸º `us-east-1`
- éœ€è¦AWS CLIé…ç½®å’ŒCloudperfStackéƒ¨ç½²å®Œæˆ

---

## æ¢æµ‹èŠ‚ç‚¹éƒ¨ç½²è„šæœ¬

### deploy_detector.sh - éƒ¨ç½²æ¢æµ‹èŠ‚ç‚¹
**åŠŸèƒ½**: åœ¨AWSæˆ–SSHæœåŠ¡å™¨ä¸Šéƒ¨ç½²ç½‘ç»œæ¢æµ‹èŠ‚ç‚¹

**ç”¨æ³•**:
```bash
./script/deploy_detector.sh [éƒ¨ç½²ç±»å‹] [éƒ¨ç½²åœ°ç‚¹] [æ¢æµ‹å™¨ç±»å‹]
```

**éƒ¨ç½²ç±»å‹**:
- `aws`: AWS EC2å®ä¾‹éƒ¨ç½²
- `ssh`: SSHè¿œç¨‹æœåŠ¡å™¨éƒ¨ç½²

**æ¢æµ‹å™¨ç±»å‹**:
- `fping-job`: ç½‘ç»œå»¶è¿Ÿæµ‹è¯•èŠ‚ç‚¹ï¼ˆé»˜è®¤ï¼‰
- `fping-pingable`: å¯ping IPå‘ç°èŠ‚ç‚¹

**ç¤ºä¾‹**:
```bash
# éƒ¨ç½²å¯ping IPå‘ç°èŠ‚ç‚¹åˆ°ç¾ä¸œ
./script/deploy_detector.sh aws us-east-1 fping-pingable

# éƒ¨ç½²å»¶è¿Ÿæµ‹è¯•èŠ‚ç‚¹åˆ°æ–°åŠ å¡
./script/deploy_detector.sh aws ap-southeast-1

# éƒ¨ç½²åˆ°å¤šä¸ªåŒºåŸŸ
./script/deploy_detector.sh aws "ap-southeast-1 us-east-1"

# éƒ¨ç½²åˆ°æ‰€æœ‰AWSåŒºåŸŸ
./script/deploy_detector.sh aws all

# éƒ¨ç½²åˆ°SSHæœåŠ¡å™¨
./script/deploy_detector.sh ssh ec2-user@1.2.3.4
```

**æŠ€æœ¯ç»†èŠ‚**:
- ä½¿ç”¨ `t4g.nano` ARM64å®ä¾‹ï¼ˆæˆæœ¬æœ€ä½ï¼‰
- è‡ªåŠ¨é…ç½®å®‰å…¨ç»„å’Œç”¨æˆ·æ•°æ®è„šæœ¬
- å®ä¾‹æ ‡ç­¾: `CostCenter=cloudperf-stack`

---

### terminate_aws_detector.sh - ç»ˆæ­¢æ¢æµ‹èŠ‚ç‚¹
**åŠŸèƒ½**: æ‰¹é‡ç»ˆæ­¢AWSä¸Šçš„æ¢æµ‹èŠ‚ç‚¹å®ä¾‹

**ç”¨æ³•**:
```bash
./script/terminate_aws_detector.sh [åŒºåŸŸ] [æ¢æµ‹å™¨ç±»å‹]
```

**ç¤ºä¾‹**:
```bash
# ç»ˆæ­¢æ‰€æœ‰åŒºåŸŸçš„fping-jobèŠ‚ç‚¹
./script/terminate_aws_detector.sh

# ç»ˆæ­¢ç¾ä¸œçš„fping-pingableèŠ‚ç‚¹
./script/terminate_aws_detector.sh us-east-1 fping-pingable

# ç»ˆæ­¢æŒ‡å®šåŒºåŸŸçš„æ‰€æœ‰èŠ‚ç‚¹
./script/terminate_aws_detector.sh us-west-2
```

**å®‰å…¨ç‰¹æ€§**:
- æ‰§è¡Œå‰éœ€è¦ç”¨æˆ·ç¡®è®¤
- ç­‰å¾…å®ä¾‹å®Œå…¨ç»ˆæ­¢åè¿”å›

---

### check_detectors.sh - æ£€æŸ¥æ¢æµ‹èŠ‚ç‚¹çŠ¶æ€
**åŠŸèƒ½**: ç›‘æ§æ‰€æœ‰éƒ¨ç½²çš„æ¢æµ‹èŠ‚ç‚¹è¿è¡ŒçŠ¶æ€

**ç”¨æ³•**:
```bash
./script/check_detectors.sh
```

**è¾“å‡ºä¿¡æ¯**:
- å®ä¾‹çŠ¶æ€ç»Ÿè®¡è¡¨
- ç³»ç»ŸAPIå¥åº·æ£€æŸ¥
- ç®¡ç†å‘½ä»¤æç¤º
- è¦†ç›–åŒºåŸŸç»Ÿè®¡

**ç¤ºä¾‹è¾“å‡º**:
```
=== CloudPerf æ£€æµ‹å™¨çŠ¶æ€ç›‘æ§ ===
éƒ¨ç½²åŒºåŸŸ: us-east-1
æ£€æŸ¥æ—¶é—´: Sun Jan 11 05:21:48 UTC 2026

ğŸŒ ç³»ç»Ÿåœ°å€: http://Cloudp-cloud-xxx.us-east-1.elb.amazonaws.com

ğŸ“Š å®ä¾‹çŠ¶æ€ç»Ÿè®¡:
åŒºåŸŸ                    å®ä¾‹ID              çŠ¶æ€      ç±»å‹        å…¬ç½‘IP
--------------------------------------------------------------------
ap-southeast-1       i-071d1c5dc2d4eb83d running  fping-job  52.221.243.8
us-east-1            i-08ce7a5b184fe8804 running  fping-pingable 34.229.148.30

ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯:
  æ€»å®ä¾‹æ•°: 2
  è¿è¡Œä¸­: 2
  è¦†ç›–åŒºåŸŸ: 2
```

---

## æ¢æµ‹èŠ‚ç‚¹ç»´æŠ¤è„šæœ¬

### update_detector.sh - æ›´æ–°æ¢æµ‹èŠ‚ç‚¹
**åŠŸèƒ½**: æ›´æ–°å·²éƒ¨ç½²æ¢æµ‹èŠ‚ç‚¹çš„äºŒè¿›åˆ¶ç¨‹åº

**ç”¨æ³•**:
```bash
./script/update_detector.sh [éƒ¨ç½²ç±»å‹] [éƒ¨ç½²åœ°ç‚¹] [æ¢æµ‹å™¨ç±»å‹]
```

**ç¤ºä¾‹**:
```bash
# æ›´æ–°æ‰€æœ‰AWSåŒºåŸŸçš„fping-job
./script/update_detector.sh aws

# æ›´æ–°ç¾ä¸œçš„fping-pingable
./script/update_detector.sh aws us-east-1 fping-pingable

# é€šè¿‡SSHæ›´æ–°
./script/update_detector.sh ssh ec2-user@1.2.3.4
```

**æŠ€æœ¯å®ç°**:
- ä½¿ç”¨AWS SSMå‘é€å‘½ä»¤
- ç­‰å¾…å‘½ä»¤æ‰§è¡Œå®Œæˆ
- æ˜¾ç¤ºæ‰§è¡Œç»“æœ

---

### remove_detector.sh - å¸è½½æ¢æµ‹èŠ‚ç‚¹
**åŠŸèƒ½**: å¸è½½æ¢æµ‹èŠ‚ç‚¹ç¨‹åºä½†ä¿ç•™å®ä¾‹

**ç”¨æ³•**:
```bash
./script/remove_detector.sh [éƒ¨ç½²ç±»å‹] [éƒ¨ç½²åœ°ç‚¹] [æ¢æµ‹å™¨ç±»å‹]
```

**ç¤ºä¾‹**:
```bash
# å¸è½½æ‰€æœ‰AWSåŒºåŸŸçš„æ¢æµ‹ç¨‹åº
./script/remove_detector.sh aws

# å¸è½½ç¾ä¸œçš„fping-pingableç¨‹åº
./script/remove_detector.sh aws us-east-1 fping-pingable
```

---

## æ•°æ®ç®¡ç†è„šæœ¬

### upload_sql.sh - ä¸Šä¼ SQLæ–‡ä»¶
**åŠŸèƒ½**: ä¸Šä¼ SQLæ–‡ä»¶åˆ°S3æ¡¶è¿›è¡Œè‡ªåŠ¨å¯¼å…¥

**ç”¨æ³•**:
```bash
./script/upload_sql.sh [sqlfile]
```

**ç¤ºä¾‹**:
```bash
# ä¸Šä¼ åˆå§‹åŒ–SQL
./script/upload_sql.sh src/data/import-sql/init.sql

# ä¸Šä¼ æ•°æ®æ–‡ä»¶
./script/upload_sql.sh cloudperf-data-20250715.zip
```

**æ”¯æŒæ ¼å¼**:
- `.sql` æ–‡ä»¶
- `.zip` å‹ç¼©åŒ…ï¼ˆåŒ…å«SQLæ–‡ä»¶ï¼‰

---

## å¼€å‘å·¥å…·è„šæœ¬

### build_web.sh - æ„å»ºWebå‰ç«¯
**åŠŸèƒ½**: æ„å»ºå¹¶å‘å¸ƒWebå‰ç«¯ä»£ç 

**ç”¨æ³•**:
```bash
./script/build_web.sh
```

**æ‰§è¡Œæµç¨‹**:
1. æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶
2. è¿è¡Œnpmæ„å»ºå‘½ä»¤
3. ç”Ÿæˆç”Ÿäº§ç¯å¢ƒä»£ç 

**æ³¨æ„**: æ„å»ºå®Œæˆåéœ€è¦é‡æ–°éƒ¨ç½²CDK

---

### local_test.sh - æœ¬åœ°æµ‹è¯•å·¥å…·
**åŠŸèƒ½**: åœ¨æœ¬åœ°ç¯å¢ƒæµ‹è¯•Lambdaå‡½æ•°

**ç”¨æ³•**:
```bash
# æµ‹è¯•ç®¡ç†å‡½æ•°
./script/local_test.sh admin '{"action":"exec_sql","param":"select * from country limit 5"}'

# æµ‹è¯•APIå‡½æ•°
./script/local_test.sh api job GET '/job' 'a=b&c=d' 'body'
```

**ç¯å¢ƒè¦æ±‚**:
- Python 3.x
- æœ¬åœ°æ•°æ®åº“è¿æ¥
- ä¿®æ”¹è„šæœ¬ä¸­çš„æ•°æ®åº“è¿æ¥å‚æ•°

---

## è„šæœ¬æ‰§è¡Œé—®é¢˜æ’æŸ¥

### å¸¸è§é—®é¢˜

1. **è„šæœ¬å¡ä½ä¸åŠ¨**
   - æ£€æŸ¥AWS CLIé…ç½®å’Œæƒé™
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - æŸ¥çœ‹CloudFormation stackçŠ¶æ€

2. **æƒé™é”™è¯¯**
   - ç¡®ä¿AWS CLIé…ç½®æ­£ç¡®
   - æ£€æŸ¥IAMæƒé™
   - éªŒè¯åŒºåŸŸè®¾ç½®

3. **å®ä¾‹å¯åŠ¨å¤±è´¥**
   - æ£€æŸ¥é…é¢é™åˆ¶
   - éªŒè¯AMIå¯ç”¨æ€§
   - æŸ¥çœ‹EC2æœåŠ¡çŠ¶æ€

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è¯¦ç»†è¾“å‡º**:
   ```bash
   set -x  # åœ¨è„šæœ¬å¼€å¤´æ·»åŠ 
   ```

2. **æ£€æŸ¥ç¯å¢ƒå˜é‡**:
   ```bash
   echo $CDK_DEFAULT_REGION
   aws sts get-caller-identity
   ```

3. **æŸ¥çœ‹æ—¥å¿—**:
   ```bash
   aws logs tail /aws/lambda/CloudperfStack-admin* --follow
   ```

### æœ€ä½³å®è·µ

1. **éƒ¨ç½²é¡ºåº**: å…ˆéƒ¨ç½²fping-pingableï¼Œç­‰å¾…2-3åˆ†é’Ÿåå†éƒ¨ç½²fping-job
2. **æˆæœ¬æ§åˆ¶**: ä½¿ç”¨æœ€å°å®ä¾‹ç±»å‹ï¼ŒåŠæ—¶æ¸…ç†ä¸éœ€è¦çš„å®ä¾‹
3. **ç›‘æ§**: å®šæœŸè¿è¡Œcheck_detectors.shæ£€æŸ¥çŠ¶æ€
4. **å¤‡ä»½**: é‡è¦æ“ä½œå‰å…ˆå¯¼å‡ºæ•°æ®

---

## ä¾èµ–è¦æ±‚

æ‰€æœ‰è„šæœ¬éƒ½éœ€è¦ä»¥ä¸‹åŸºç¡€ç¯å¢ƒ:

- **AWS CLI**: å·²é…ç½®ä¸”æœ‰è¶³å¤Ÿæƒé™
- **curl**: ç”¨äºä¸‹è½½å®‰è£…è„šæœ¬
- **bash**: è„šæœ¬è¿è¡Œç¯å¢ƒ
- **CloudperfStack**: CDKéƒ¨ç½²å®Œæˆ

éƒ¨åˆ†è„šæœ¬çš„é¢å¤–ä¾èµ–:
- **SSMæƒé™**: update_detector.sh å’Œ remove_detector.sh
- **EC2æƒé™**: æ‰€æœ‰AWSç›¸å…³è„šæœ¬
- **Python 3.x**: local_test.sh