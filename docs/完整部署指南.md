# CloudPerf 完整部署指南

本指南基于实际部署经验，提供详细的步骤说明和故障排查方法。

## 前置要求

### 环境准备
- **Node.js** >= 22.x
- **AWS CLI** 已安装并配置好权限
- **AWS CDK CLI**: `npm install -g aws-cdk`
- **Python 3.12** (可选，用于本地测试)
- **Docker** (可选，用于构建二进制包)

### AWS权限要求
确保AWS CLI配置的用户具有以下权限：
- CloudFormation 完整权限
- EC2 完整权限
- RDS 完整权限
- Lambda 完整权限
- S3 完整权限
- ElastiCache 完整权限
- Application Load Balancer 权限
- Secrets Manager 权限

## 部署步骤

### 第一步：代码准备
```bash
# 克隆代码
git clone https://github.com/tansoft/cloudperf.git
cd cloudperf

# 安装依赖
npm install

# (可选) 指定部署区域，默认为 us-east-1
export CDK_DEFAULT_REGION=us-east-1

# CDK 初始化
cdk bootstrap
cdk synth
```

### 第二步：部署基础设施
```bash
echo "开始部署CloudPerf基础设施..."
cdk deploy --require-approval never
```

**预期结果**：
- 部署时间约 15-20 分钟
- 成功后会显示重要的输出信息，包括：
  - `customHost`: 系统访问地址
  - `adminLambda`: 管理Lambda函数名
  - `s3Bucket`: 数据存储桶名
  - `dbHost`: 数据库地址

### 第三步：数据库初始化
```bash
echo "初始化数据库..."
./script/admin_exec.sh exec_sql init_db

echo "上传建表SQL..."
./script/upload_sql.sh src/data/import-sql/init.sql
```

### 第四步：导入基础数据
```bash
echo "下载并导入基础数据..."
wget -q https://d.tansoft.org/cloudperf-data-20250715.zip
./script/upload_sql.sh cloudperf-data-20250715.zip

echo "下载并导入稳定ping IP列表..."
wget -q https://d.tansoft.org/cloudperf-stableping-20250715.zip
./script/upload_sql.sh cloudperf-stableping-20250715.zip
```

**注意**：数据导入是异步的，大文件可能需要几分钟时间。

### 第五步：创建管理员账号
```bash
echo "创建管理员账号..."
./script/admin_exec.sh create_user admin
```

### 第六步：部署探测节点

#### 6.1 部署IP发现节点
```bash
echo "部署pingable任务（IP发现）..."
./script/deploy_detector.sh aws us-east-1 fping-pingable

echo "等待pingable任务启动..."
sleep 120
```

#### 6.2 部署延迟测试节点

**选项A：部署到单个区域（测试用）**
```bash
./script/deploy_detector.sh aws ap-southeast-1
```

**选项B：部署到所有AWS区域（生产用）**
```bash
echo "部署到所有AWS区域..."
./script/deploy_detector.sh aws all
```

### 第七步：验证部署
```bash
echo "检查部署状态..."
./script/check_detectors.sh

echo "获取系统访问地址..."
aws cloudformation describe-stacks --stack-name CloudperfStack --query 'Stacks[0].Outputs[?OutputKey==`customHost`].OutputValue' --output text --region ${CDK_DEFAULT_REGION:-us-east-1}
```

## 部署完成

### 系统信息
部署成功后，你将获得：
- **系统访问地址**: `http://your-alb-host/login`
- **管理员账号**: `admin`
- **管理员密码**: 在创建用户时显示

### 探测节点覆盖
- **全球部署**: 17个AWS区域
- **节点类型**:
  - 1个 `fping-pingable` (us-east-1) - 负责发现可ping IP
  - 17个 `fping-job` - 分布在全球各区域进行延迟测试

### 覆盖区域
- **亚太**: ap-south-1, ap-northeast-1/2/3, ap-southeast-1/2
- **欧洲**: eu-north-1, eu-west-1/2/3, eu-central-1  
- **美洲**: us-east-1/2, us-west-1/2, ca-central-1, sa-east-1

## 故障排查

### 常见问题

#### 1. CDK部署失败
```bash
# 检查AWS权限
aws sts get-caller-identity

# 检查CDK版本
cdk --version

# 重新bootstrap
cdk bootstrap --force
```

#### 2. 管理员账号创建失败
```bash
# 检查Lambda函数是否存在
aws lambda list-functions --query 'Functions[?contains(FunctionName, `admin`)].FunctionName'

# 手动调用Lambda创建用户
aws lambda invoke --function-name YOUR_ADMIN_LAMBDA_NAME --payload '{"action":"create_user","param":"admin"}' --region us-east-1 --cli-binary-format raw-in-base64-out --log-type Tail --output text --query 'LogResult' response.json | base64 -d
```

#### 3. 数据导入失败
```bash
# 检查S3桶
aws s3 ls s3://YOUR_S3_BUCKET/import-sql/

# 查看Lambda日志
aws logs tail /aws/lambda/CloudperfStack-admin* --follow
```

#### 4. 探测节点启动失败
```bash
# 检查实例状态
./script/check_detectors.sh

# 查看实例日志
aws ec2 describe-instances --instance-ids YOUR_INSTANCE_ID --query 'Reservations[].Instances[].State'
```

### 调试命令

```bash
# 查看系统状态
./script/check_detectors.sh

# 检查数据采集情况
./script/admin_exec.sh exec_sql "SELECT COUNT(*) FROM statistics WHERE update_time > DATE_SUB(NOW(), INTERVAL 1 HOUR)"

# 查看可ping IP数量
./script/admin_exec.sh exec_sql "SELECT COUNT(*) FROM pingable WHERE status > 0"
```

## 成本估算

### 基础成本（无探测节点）
- **RDS Aurora Serverless**: ~$400-500/月
- **Lambda + ALB + 其他**: ~$50/月

### 探测节点成本
- **单个t4g.nano实例**: ~$3.5/月
- **17个区域全部部署**: ~$60/月
- **总成本（全球部署）**: ~$550/月

### 成本优化
- 可以随时停止探测节点：`./script/terminate_aws_detector.sh`
- 数据库可以设置为0 ACU以降低成本
- 按需启动探测节点进行测试

## 维护操作

### 日常维护
```bash
# 检查系统状态
./script/check_detectors.sh

# 更新探测节点
./script/update_detector.sh aws all

# 备份数据
./script/admin_exec.sh mysql_dump "country,city,asn,iprange,cityset"
```

### 清理资源
```bash
# 停止所有探测节点
./script/terminate_aws_detector.sh

# 删除整个系统
cdk destroy
```

## 自定义配置

### 使用自定义域名
```bash
# 部署时指定域名和Route53 Zone ID
cdk deploy -c domainName=ping.yourdomain.com -c hostedZoneId=Z1234567890
```

### 修改系统参数
编辑 `src/layer/datalayer/python/settings.py`：
```python
# 每个cityid保存的记录数
MAX_RECORDS_PER_CITYID = 7

# 缓存过期时间
CACHE_BASE_TTL = 3600
CACHE_LONG_TTL = 86400
```

## 下一步

1. 登录系统查看数据采集情况
2. 在 `/status` 页面监控探测节点状态  
3. 使用 `/ipsearch` 查询IP信息
4. 通过 `/performance` 分析网络延迟数据
5. 根据需要调整探测节点部署策略

---

**注意**: 首次部署后，探测节点需要几分钟时间开始采集数据。可以通过Web界面的状态页面监控数据采集进度。